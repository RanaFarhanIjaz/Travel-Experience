@model List<Review>
@{
    ViewData["Title"] = "Search Travel Reviews";
    
    // Get session values
    var userEmail = Context.Session.GetString("UserEmail");
    
    // Admin check with multiple methods to ensure it works
    var isAdmin = false;
    
    if (!string.IsNullOrEmpty(userEmail))
    {
        // Method 1: Check session
        var sessionIsAdmin = Context.Session.GetString("IsAdmin");
        if (sessionIsAdmin == "true")
        {
            isAdmin = true;
        }
        
        // Method 2: Check email (backup)
        if (userEmail == "admin@travel.com")
        {
            isAdmin = true;
            // Also update session to be sure
            Context.Session.SetString("IsAdmin", "true");
        }
    }
}

<div class="container">
    <h2 class="mb-4">Search Travel Reviews</h2>

    @if (isAdmin)
    {
        <div class="alert alert-warning mb-3">
            <strong>üëë ADMIN MODE:</strong> You can delete ANY review on this page.
        </div>
    }

    <!-- Search Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-4">
                    <input type="text" name="search" class="form-control" placeholder="Search by place name, location, or description..." value="@Context.Request.Query["search"]">
                </div>
                <div class="col-md-3">
                    <select name="placeType" class="form-select">
                        <option value="">All Types</option>
                        <option value="Hotel">Hotel</option>
                        <option value="Restaurant">Restaurant</option>
                        <option value="VisitingPlace">Visiting Place</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select name="minRating" class="form-select">
                        <option value="0">All Ratings</option>
                        <option value="5">5 Stars</option>
                        <option value="4">4+ Stars</option>
                        <option value="3">3+ Stars</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">Search</button>
                </div>
            </form>
        </div>
    </div>

    @if (Model.Any())
    {
        <div class="row">
            @foreach (var review in Model)
            {
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <!-- Display Image/Video thumbnail if available -->
                            @if (!string.IsNullOrEmpty(review.ImagePath))
                            {
                                <img src="@review.ImagePath" class="card-img-top mb-3" alt="@review.PlaceName" style="height: 200px; object-fit: cover;">
                            }
                            else if (!string.IsNullOrEmpty(review.VideoPath))
                            {
                                <div class="bg-dark text-center mb-3 rounded" style="height: 200px; display: flex; align-items: center; justify-content: center;">
                                    <span class="text-white">üé• Video Review</span>
                                </div>
                            }
                            
                            <h5 class="card-title">@review.PlaceName</h5>
                            <h6 class="card-subtitle mb-2 text-muted">
                                @review.PlaceType - @review.Location
                                @if (isAdmin && userEmail != review.Author)
                                {
                                    <br><small class="text-info">üë§ Posted by: @review.Author</small>
                                }
                            </h6>
                            
                            <p class="card-text">
                                @if (review.Description.Length > 150)
                                {
                                    @review.Description.Substring(0, 150)<text>...</text>
                                }
                                else
                                {
                                    @review.Description
                                }
                            </p>
                            
                            <div class="mb-2">
                                @for (int i = 1; i <= 5; i++)
                                {
                                    <span class="text-warning">@(i <= review.Rating ? "‚òÖ" : "‚òÜ")</span>
                                }
                                <span class="text-muted">(@review.CreatedDate.ToString("MMM dd, yyyy"))</span>
                            </div>
                            
                            <!-- DELETE BUTTON FIXED SECTION -->
                            <div class="d-flex justify-content-between align-items-center">
                                <a href="@Url.Action("Details", "Review", new { id = review.Id })" class="btn btn-primary btn-sm">View Details</a>
                                
                                @{
                                    var currentUserEmail = Context.Session.GetString("UserEmail");
                                    var currentUserIsAdmin = Context.Session.GetString("IsAdmin") == "true" || currentUserEmail == "admin@travel.com";
                                    var isReviewOwner = currentUserEmail == review.Author;
                                    
                                    // Show delete button if admin OR review owner
                                    var showDeleteButton = currentUserIsAdmin || isReviewOwner;
                                }
                                
                                @if (showDeleteButton)
                                {
                                    <form asp-action="Delete" asp-controller="Review" method="post" onsubmit="return confirm('Are you sure you want to delete this review?');">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="id" value="@review.Id" />
                                        <button type="submit" class="btn btn-danger btn-sm">
                                            @if (currentUserIsAdmin && !isReviewOwner)
                                            {
                                                <text>üóëÔ∏è Delete (Admin)</text>
                                            }
                                            else
                                            {
                                                <text>üóëÔ∏è Delete</text>
                                            }
                                        </button>
                                    </form>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="alert alert-info text-center">
            <h4>No reviews found!</h4>
            <p>Try adjusting your search criteria or <a href="@Url.Action("Add", "Review")">add a new review</a>.</p>
        </div>
    }

    @if (!string.IsNullOrEmpty(Context.Session.GetString("UserEmail")))
    {
        <div class="text-center mt-4">
            <a href="@Url.Action("Add", "Review")" class="btn btn-success">Add New Review</a>
            <a href="@Url.Action("Dashboard", "Home")" class="btn btn-outline-primary ms-2">My Dashboard</a>
        </div>
    }
    else
    {
        <div class="text-center mt-4">
            <a href="@Url.Action("Login", "Account")" class="btn btn-primary">Login to Add Reviews</a>
        </div>
    }

<!-- AI Travel Assistant Card -->
<div class="card mt-4">
    <div class="card-header bg-success text-white">
        <h5 class="mb-0">ü§ñ AI Travel Assistant</h5>
    </div>
    <div class="card-body">
        <p class="card-text">Need travel advice? Ask our AI assistant for recommendations, tips, and more!</p>
        <a href="@Url.Action("Index", "AI")" class="btn btn-success">Open AI Assistant</a>
    </div>
</div>

</div>